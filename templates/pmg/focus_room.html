{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/myStyle.css') }}">
    <style>
    .container {
        display: flex;
        flex-direction: row;
        width: 100%;
        height: 100vh;
        align-items: center; /* Centrera elementen horisontellt */
        justify-content: center; /* Centrera elementen vertikalt */
    }
    </style>
{% endblock head %}

{% block body %}
<div class="container">
    <div class="todo-list" id="todo-list-{{ activity.id }}" style="justify-content: center; align-items: center;">
        <h4>{{ activity.name }} To-Do</h4>
        <ul>
        {% for task in tasks %}
            <li class="{% if task.completed %}completed-task{% endif %}">
                {{ task.task }}
                <form method="POST" action="{{ url_for('pmg.update_task', activity_id=activity.id, task_id=task.id) }}">
                    <input type="hidden" name="origin" value="todo_list">
                    <input type="checkbox" class="task-checkbox" name="completed"
                        onchange="this.form.submit()"  {% if task.completed %} checked {% endif %}>
                </form>
            </li>
        {% endfor %}
        </ul>
        <form action="{{ url_for('pmg.add_task', activity_id=activity.id) }}" method="POST">
            <input type="hidden" name="actId" value="{{ activity.id }}">
            <input type="hidden" name="origin" value="focus">
            <input type="text" name="task_name" placeholder="Enter new task" required>
            <button onclick="" type="submit" name="action" value="addTodo">Add Task</button>
        </form>
        <div class="button-center">
            <button id="stopButton" class="button-style" style="background-color:red" onclick="stopActivity()">Stop</button>
            <button id="continueButton" class="button-style" style="display: none; background-color: green" onclick="">Continue</button>
        </div>
    </div>
    <form method="POST">
        <div id="completed-form" class="form-container" style="display:none;">
            <input type="text" id="aID" name="aID" >
            <input type="text" id="aDate" name="aDate" value="{{ current_date }}">
            <input type="text" id="start" name="start">
            <input type="text" id="end" name="end">
            <input type="number" id="score" name="score">
            <div class="button-center" id="complete-form" style="display:none;">
                <button type="submit" onclick="turnOff" name="action" id="save-btn" class="button-style" value="save-score">Save</button>
            </div>
        </div>
    </form>
<div class="activity-notes" style="display:flex; flex-direction: column; width:20%; max-height: 80%; justify-content:center;align-items: center; text-align: left;">
 {% if activity_notes %}
    <div class="right-container">
        {% for note in activity_notes %}
        <div class="collapsed-notes">
            <h5 class="note-title" onclick="toggleList(this)" style="cursor: pointer;" data-note-id="{{ note.id }}">{{ note.title }}</h5>
            <form method="POST" action="{{ url_for('pmg.update_note', note_id=note.id) }}" class="note-form" style="display:inline;">
                <div>
                    <textarea name="content" style="height:300px; max-height: 60%">{{ note.content }}</textarea>
                </div>
                <button type="submit" class="button-style">Save</button>
            </form>
        </div>
        {% endfor %}
        <div class="new-notebook-form">
        <h4>Create a New Notebook</h4>
        <form method="POST" action="{{ url_for('pmg.create_notebook', activity_id=activity.id) }}">
            <div>
                <label for="notebook-title">Notebook Title:</label>
                <input type="text" id="notebook-title" name="title" required>
            </div>
            <button type="submit" class="button-style">Create Notebook</button>
        </form>
    </div>
</div>
    {% endif %}
</div>
</div>



<script src="{{ url_for('static', filename='common_functions.js') }}"></script>
<script>
    function toggleList(element) {
        const content = element.nextElementSibling;
        content.style.display = content.style.display === 'none' || content.style.display === '' ? 'block' : 'none';
    }
document.addEventListener('DOMContentLoaded', function() {

    if (localStorage.getItem('active') === 'true') {
        console.log("En aktivitet är redan aktiv.");
        return;  // Avsluta om en aktivitet redan pågår
    }
    // Hämta alla note-titlar och lägg till en event listener för klick
    document.querySelectorAll('.note-title').forEach(title => {
        title.addEventListener('click', function() {
            const noteForm = this.nextElementSibling; // Formen som ligger direkt efter titeln

            // Kontrollera om formen är dold eller inte, växla visning
            if (noteForm.style.display === 'none' || noteForm.style.display === '') {
                noteForm.style.display = 'block';
            } else {
                noteForm.style.display = 'none';
            }
        });
    });

    // Visa spara-knappen när texten ändras
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
            const saveButton = this.closest('form').querySelector('button[type="submit"]');
            saveButton.style.display = 'inline-block';  // Visa spara-knappen när text ändras
        });
    });

    // Lägg till event listeners för uppgifter
    document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const taskId = this.dataset.taskId;
            const isCompleted = this.checked;
            updateTaskStatus(taskId, isCompleted);
        });
    });
});

function turnOff() {
    localStorage.setItem(active, false);
}

function updateTaskStatus(taskId, isCompleted) {
    fetch(`/tasks/${taskId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()  // Om du använder CSRF-skydd
        },
        body: JSON.stringify({
            completed: isCompleted
        }),
    }
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Task updated successfully');
        } else {
            console.error('Error updating task:', data.error);
        }
    }))
}
</script>
{% endblock body %}