{% extends 'base.html' %}

{% block head %}
<style>

.subtask-item input[type="checkbox"] {
    margin-left: 10px;
    transform: scale(1.2);
    cursor: pointer;
}

.subtask-item span {
    flex-grow: 1;
    text-align: left;
    padding-right: 10px;
    font-size: 16px;
    color: #333;
}

/* Indrag f√∂r subtasks f√∂r att indikera hierarki */
.subtask-list {
    padding: 5px; /* Indrag */
    margin: 10px 0;
    border-left: 2px dashed #ccc; /* Visuellt skilja subtasks */
}
.hidden {
    display: none;
}

.list-item:hover {
    background-color: #f0f0f0; /* L√§gg till hover-effekt */
}
.task-actions {
    display: flex;
    align-items: center;
}

</style>
{% endblock head %}

{% block body %}
<div class="list-container">
    <div class="list-header">
        <h3>{{ activity.name }} - Tasks</h3>
    </div>
   <div class="list-content">
        {% if tasks %}
            {% for task in tasks %}
        <div class="striped-list">
            <div class="list-item" draggable="true" data-target="subtasks-{{ task.id }}"
            ondragstart="dragStart(event)" ondragover="allowDrop(event)" ondrop="dropTask(event)">
                <span>{{ task.task }}</span>
                <!-- Om task √§r upprepningsbar, visa repetitionstatus -->
                {% if task.is_repeatable %}
                    <span class="repeat-status">Repetitioner: {{ task.completed_repeats }} / {{ task.total_repeats }}</span>
                {% endif %}
                {% if task.shared_item_id %}
                    <span class="shared-indicator">(Shared)</span>
                {% endif %}
                <span class="subtask-count">
                    {{ task.completed_subtasks }} / {{ task.subtask_count }} avklarade
                </span>
                <div class="task-actions">
                    <form method="POST" action="{{ url_for('pmg.update_task', activity_id=activity.id, task_id=task.id) }}">
                        <input type="hidden" name="origin" value="todo">
                        <input type="checkbox" name="completed" value="list" onchange="this.form.submit()" {% if task.completed %}checked{% endif %}>
                    </form>
                    <form method="POST" action="{{ url_for('pmg.delete_task', activity_id=activity.id, task_id=task.id) }}" style="display: inline;">
                        <button type="submit" class="delete-btn" onclick="return confirm('√Ñr du s√§ker p√• att du vill radera denna task?')">üóëÔ∏è</button>
                    </form>
                </div>
            </div>
            <ul id="subtasks-{{ task.id }}" class="subtask-list hidden">
                {% for subtask in task.subtasks %}
                    <li class="subtask-item" id="subtask-{{ subtask.id }}" draggable="true"
                    ondragstart="dragStart(event)" ondragover="allowDrop(event)" ondrop="dropTask(event)">
                        <span>{{ subtask.name }}</span>
                        <form method="POST" action="{{ url_for('pmg.update_subtask', subtask_id=subtask.id) }}">
                            <input type="checkbox" name="completed" onchange="this.form.submit()" {% if subtask.completed %}checked{% endif %}>
                        </form>
                    </li>
                {% endfor %}

                <!-- Form f√∂r att l√§gga till ny subtask -->
                <form method="POST" action="{{ url_for('pmg.add_subtask', task_id=task.id) }}" class="add-form-container">
                    <input type="text" name="subtask_name" placeholder="Enter new subtask" required>
                    <button type="submit">Add</button>
                </form>
            </ul>
        </div>
            {% endfor %}
        {% else %}
            <p>No tasks found for this activity.</p>
        {% endif %}

        <form action="{{ url_for('pmg.add_task', activity_id=activity.id) }}" method="POST">
            <input type="hidden" name="actId" value="{{ activity.id }}" style="display: none">
            <input type="hidden" name="origin" value="focus" style="display: none">
            <input type="text" name="task_name" placeholder="Enter new task" required>
            <button onclick="" type="submit" name="action" style="height: 1.5rem;" value="addTodo">Add</button>
        </form>
</div>
    <div class="button-center">
            <button id="stopButton" class="button-style" style="background-color:red" onclick="stopActivity()">Stop</button>
            <button id="continueButton" class="button-style" style="display: none; background-color: green" onclick="">Continue</button>
    </div>
    <form method="POST" class="form-container" id="completed-form">
        <div>
            <input type="text" id="aID" name="aID" style="display: none">
            <input type="text" id="aDate" name="aDate" value="{{ current_date }}" style="display: none">
            <input type="text" id="start" name="start" style="display: none">
            <input type="text" id="end" name="end" style="display: none">
            <input type="number" id="elapsedTime" name="score" style="display: none">
            <div class="button-center" id="complete-form" style="width:40%; display: none">
                <button type="submit" onclick="turnOff()" name="action" id="save-btn" class="button-style" value="save-score">Save</button>
            </div>
        </div>
    </form>
</div>
<div class="activity-notes" style="margin-left: 0; max-width:30%; max-height: 80%; align-items:center; text-align: left;">
 {% if activity_notes %}
    <div class="right-container">
        {% for note in activity_notes %}
            <div class="collapsed-notes">
                <h5 class="note-title" onclick="toggleList(this)" style="cursor: pointer;" data-note-id="{{ note.id }}">{{ note.title }}</h5>
                <form method="POST" action="{{ url_for('pmg.update_note', note_id=note.id) }}" class="note-form" style="display:inline;">
                    <div>
                        <textarea name="content" style="height:300px; max-height: 60%">{{ note.content }}</textarea>
                    </div>
                    <button type="submit" class="button-style">Save</button>
                </form>
            </div>
        {% endfor %}
        {% endif %}
    </div>
        <div class="activity-notes-">
            <form method="POST" action="{{ url_for('pmg.create_notebook', activity_id=activity.id) }}">
                <div>
                    <label for="notebook-title">New Notebook:</label>
                    <input type="text" id="notebook-title" name="title" required>
                </div>
                <button type="submit" class="button-style">Create Notebook</button>
            </form>
        </div>
</div>
<script src="{{ url_for('static', filename='common_functions.js') }}"></script>

<script>
        let draggedItem = null;

        function dragStart(event) {
        draggedItem = event.target;
        event.dataTransfer.setData("text/plain", event.target.id);
    }

        function allowDrop(event) {
        event.preventDefault();
    }

        function dropTask(event) {
        event.preventDefault();
        const targetId = event.target.closest('.list-item, .subtask-item').id;
        const targetElement = document.getElementById(targetId);

        if (draggedItem.classList.contains('list-item')) {
        // Hantera flytt av en task
        if (targetElement.classList.contains('list-item')) {
        targetElement.parentNode.insertBefore(draggedItem, targetElement.nextSibling);
    }
    } else if (draggedItem.classList.contains('subtask-item')) {
        // Hantera flytt av en subtask
        if (targetElement.classList.contains('list-item')) {
        // Flytta en subtask till en ny task
        const subtaskList = targetElement.querySelector('.subtask-list');
        subtaskList.appendChild(draggedItem);
    } else if (targetElement.classList.contains('subtask-item')) {
        // Flytta mellan subtasks
        targetElement.parentNode.insertBefore(draggedItem, targetElement.nextSibling);
    }
    }

        updateOrderOnServer();
    }
        function updateOrderOnServer() {
        const taskList = document.getElementById('task-list');
        const tasks = Array.from(taskList.children).map((task, index) => {
        const subtasks = Array.from(task.querySelectorAll('.subtask-item')).map((subtask, subIndex) => {
        return {id: subtask.id.replace('subtask-', ''), order: subIndex};
    });
        return {
        id: task.id.replace('task-', ''),
        order: index,
        subtasks: subtasks
    };
    });

        fetch('pmg/update-task-order', {
        method: 'POST',
        headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
        body: JSON.stringify(tasks)
    }).then(response => {
        if (response.ok) {
        console.log('Order updated successfully!');
    } else {
        console.error('Error updating order.');
    }
    });
    }

    document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.list-item').forEach(item => {
    item.addEventListener('click', (event) => {
    // F√∂rhindra klick om checkboxen klickas
    if (event.target.tagName === 'INPUT') return;

    const targetId = item.getAttribute('data-target');
    const targetList = document.getElementById(targetId);

    if (targetList.classList.contains('hidden')) {
    targetList.classList.remove('hidden');
    } else {
    targetList.classList.add('hidden');
    }
    });
    });
    });

    function toggleList(element) {
    const content = element.nextElementSibling;
    content.style.display = content.style.display === 'none' || content.style.display === '' ? 'block' : 'none';
    }
    document.addEventListener('DOMContentLoaded', function() {

    if (localStorage.getItem('active') === 'true') {
    console.log("En aktivitet √§r redan aktiv.");
    return; // Avsluta om en aktivitet redan p√•g√•r
    }

    // Skrolla till botten av
    const todoListContainer = document.getElementById('todo-list-container');
    todoListContainer.scrollTop = todoListContainer.scrollHeight;

    // H√§mta alla note-titlar och l√§gg till en event listener f√∂r klick
    document.querySelectorAll('.note-title').forEach(title => {
    title.addEventListener('click', function() {
    const noteForm = this.nextElementSibling; // Formen som ligger direkt efter titeln

    // Kontrollera om formen √§r dold eller inte, v√§xla visning
    if (noteForm.style.display === 'none' || noteForm.style.display === '') {
    noteForm.style.display = 'block';
    } else {
    noteForm.style.display = 'none';
    }
    });
    });

    // Visa spara-knappen n√§r texten √§ndras
    document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
    const saveButton = this.closest('form').querySelector('button[type="submit"]');
    saveButton.style.display = 'inline-block'; // Visa spara-knappen n√§r text √§ndras
    });
    });

    // L√§gg till event listeners f√∂r uppgifter
    document.querySelectorAll('.task-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function () {
    const taskId = this.dataset.taskId;
    const isCompleted = this.checked;
            updateTaskStatus(taskId, isCompleted);
        });
    });
});

function turnOff() {
    localStorage.setItem(active, false);
}

function updateTaskStatus(taskId, isCompleted) {
    fetch(`/tasks/${taskId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()  // Om du anv√§nder CSRF-skydd
        },
        body: JSON.stringify({
            completed: isCompleted
        }),
    }
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Task updated successfully');
        } else {
            console.error('Error updating task:', data.error);
        }
    }))
}
</script>
{% endblock body %}