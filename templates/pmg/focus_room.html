{% extends 'base.html' %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/myStyle.css') }}">
    <style>

    </style>
{% endblock head %}

{% block body %}
<div class="todo-list" id="todo-list-container" style="justify-content: center; align-items: center; max-height: 60%; width: 45%;">
    <h4 class="list-header">{{ activity.name }} To-Do</h4>
    <div class="list-content">
        <ul>
            {% for task in tasks %}
            <li class="{% if task.completed %}completed-task{% endif %}">
                {{ task.task }}
                <form method="POST" action="{{ url_for('pmg.update_task', activity_id=activity.id, task_id=task.id) }}">
                    <input type="hidden" name="origin" value="focus">
                    <input type="checkbox" class="task-checkbox" name="completed"
                        onchange="this.form.submit()"  {% if task.completed %} checked {% endif %}>
                </form>
            </li>
            {% endfor %}
        </ul>
        <form style="display: flex; flex-direction: row; padding: 0 4rem 0 4rem; gap: 1rem; justify-content: space-evenly; width: 60%"
              action="{{ url_for('pmg.add_task', activity_id=activity.id) }}" method="POST">

            <input type="hidden" name="actId" value="{{ activity.id }}" style="display: none">
            <input type="hidden" name="origin" value="focus" style="display: none">
            <input type="text" name="task_name" placeholder="Enter new task" required>
            <button onclick="" type="submit" name="action" style="height: 1.5rem;" value="addTodo">Add</button>
        </form>
    </div>
</div>
    <div class="button-center">
            <button id="stopButton" class="button-style" style="background-color:red" onclick="stopActivity()">Stop</button>
            <button id="continueButton" class="button-style" style="display: none; background-color: green" onclick="">Continue</button>
    </div>

    <form method="POST" class="form-container" id="completed-form">
        <div>
            <input type="text" id="aID" name="aID" style="display: none">
            <input type="text" id="aDate" name="aDate" value="{{ current_date }}" style="display: none">
            <input type="text" id="start" name="start" style="display: none">
            <input type="text" id="end" name="end" style="display: none">
            <input type="number" id="elapsedTime" name="score" style="display: none">
            <div class="button-center" id="complete-form" style="width:40%; display: none">
                <button type="submit" onclick="turnOff()" name="action" id="save-btn" class="button-style" value="save-score">Save</button>
            </div>
        </div>
    </form>

<div class="activity-notes" style="margin-left: 0; max-width:30%; max-height: 80%; align-items:center; text-align: left;">
 {% if activity_notes %}
    <div class="right-container">
        {% for note in activity_notes %}
        <div class="collapsed-notes">
            <h5 class="note-title" onclick="toggleList(this)" style="cursor: pointer;" data-note-id="{{ note.id }}">{{ note.title }}</h5>
            <form method="POST" action="{{ url_for('pmg.update_note', note_id=note.id) }}" class="note-form" style="display:inline;">
                <div>
                    <textarea name="content" style="height:300px; max-height: 60%">{{ note.content }}</textarea>
                </div>
                <button type="submit" class="button-style">Save</button>
            </form>
        </div>
        {% endfor %}
        <div class="new-notebook-form">
            <h4>Create a New Notebook</h4>
            <form method="POST" action="{{ url_for('pmg.create_notebook', activity_id=activity.id) }}">
                <div>
                    <label for="notebook-title">Notebook Title:</label>
                    <input type="text" id="notebook-title" name="title" required>
                </div>
                <button type="submit" class="button-style">Create Notebook</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>
<script src="{{ url_for('static', filename='common_functions.js') }}"></script>
<script>
    function toggleList(element) {
        const content = element.nextElementSibling;
        content.style.display = content.style.display === 'none' || content.style.display === '' ? 'block' : 'none';
    }
document.addEventListener('DOMContentLoaded', function() {

    if (localStorage.getItem('active') === 'true') {
        console.log("En aktivitet är redan aktiv.");
        return;  // Avsluta om en aktivitet redan pågår
    }

    // Skrolla till botten av
    const todoListContainer = document.getElementById('todo-list-container');
    todoListContainer.scrollTop = todoListContainer.scrollHeight;

    // Hämta alla note-titlar och lägg till en event listener för klick
    document.querySelectorAll('.note-title').forEach(title => {
        title.addEventListener('click', function() {
            const noteForm = this.nextElementSibling; // Formen som ligger direkt efter titeln

            // Kontrollera om formen är dold eller inte, växla visning
            if (noteForm.style.display === 'none' || noteForm.style.display === '') {
                noteForm.style.display = 'block';
            } else {
                noteForm.style.display = 'none';
            }
        });
    });

    // Visa spara-knappen när texten ändras
    document.querySelectorAll('textarea').forEach(textarea => {
        textarea.addEventListener('input', function() {
            const saveButton = this.closest('form').querySelector('button[type="submit"]');
            saveButton.style.display = 'inline-block';  // Visa spara-knappen när text ändras
        });
    });

    // Lägg till event listeners för uppgifter
    document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function () {
            const taskId = this.dataset.taskId;
            const isCompleted = this.checked;
            updateTaskStatus(taskId, isCompleted);
        });
    });
});

function turnOff() {
    localStorage.setItem(active, false);
}

function updateTaskStatus(taskId, isCompleted) {
    fetch(`/tasks/${taskId}/update`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()  // Om du använder CSRF-skydd
        },
        body: JSON.stringify({
            completed: isCompleted
        }),
    }
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Task updated successfully');
        } else {
            console.error('Error updating task:', data.error);
        }
    }))
}
</script>
{% endblock body %}