{% extends 'base.html' %}

{% block head %}
<style>
    .hidden {
        display: none;
    }
    .subtasks-container {
        margin-left: 20px;
        list-style-type: circle;
    }
    .list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        cursor: pointer; /* Gör hela raden klickbar */
    }
    .list-item:hover {
        background-color: #f0f0f0; /* Lägg till hover-effekt */
    }
    .task-actions {
        display: flex;
        align-items: center;
    }
</style>
{% endblock head %}

{% block body %}
<div class="list-container">
    <div class="list-header">
        <h3>{{ activity.name }} - Tasks</h3>
    </div>
    <div class="list-content">
        {% if tasks %}
            {% for task in tasks %}
                <div class="list-item" data-target="subtasks-{{ task.id }}">
                    <div>
                        {{ task.task }}
                        {% if task.shared_item_id %}
                            <span class="shared-indicator">(Shared)</span>
                        {% endif %}
                    </div>
                    <div class="task-actions">
                        <form method="POST" action="{{ url_for('pmg.update_task', activity_id=activity.id, task_id=task.id) }}">
                            <input type="hidden" name="origin" value="todo">
                            <input type="checkbox" name="completed" value="list" onchange="this.form.submit()" {% if task.completed %}checked{% endif %}>
                        </form>
                    </div>
                </div>
                <!-- Subtasks-container (hidden by default) -->
                <ul id="subtasks-{{ task.id }}" class="list-item hidden">
                    {% for subtask in task.subtasks %}
                        <li>
                            {{ subtask.name }}
                            <form method="POST" action="{{ url_for('pmg.update_subtask', subtask_id=subtask.id) }}">
                                <input type="checkbox" name="completed" onchange="this.form.submit()" {% if subtask.completed %}checked{% endif %}>
                            </form>
                        </li>
                    {% endfor %}
                    <!-- Form to add new subtask -->
                    <li>
                        <form method="POST" action="{{ url_for('pmg.add_subtask', task_id=task.id) }}">
                            <input type="text" name="subtask_name" placeholder="Add subtask">
                            <button type="submit">Add</button>
                        </form>
                    </li>
                </ul>
            {% endfor %}
        {% else %}
            <p>No tasks found for this activity.</p>
        {% endif %}
    </div>
    <div class="add-form-container" style="display:flex; flex-direction: row; justify-content: center; align-items: center; width:100%; margin-inline: auto">
        <form action="{{ url_for('pmg.add_task', activity_id=activity.id) }}" method="POST">
            <input type="hidden" name="origin" value="todo">
            <input style="text-align: left; width: 500px; height: 20px; padding:5px; border: black solid 1px;" type="text" name="task_name" placeholder="New Task Name" required>
            <button style="margin: 20px; color: white;font-weight: bold; background-color: #4caf50; border-radius: 3px;" type="submit">Add</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.list-item').forEach(item => {
            item.addEventListener('click', (event) => {
                // Förhindra klick om checkboxen klickas
                if (event.target.tagName === 'INPUT') return;

                const targetId = item.getAttribute('data-target');
                const targetList = document.getElementById(targetId);

                if (targetList.classList.contains('hidden')) {
                    targetList.classList.remove('hidden');
                } else {
                    targetList.classList.add('hidden');
                }
            });
        });
    });
</script>
{% endblock body %}
