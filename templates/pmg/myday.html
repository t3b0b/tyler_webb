{% extends 'base.html' %}

{% block head %}
<style>


.streak-icon {
    border: none;
    background: none;
    cursor: pointer;
}
</style>

{% endblock head %}

{% block body %}
<div class="top-five">
    <div class="top5-container">
        <!-- Visa listan bara om det inte finns värden i top_five.items -->
        <div class="head-list" onclick="toggleList(this)">Priorities</div>
        <div class="five-list-content">
            <form method="POST">
                <div class="tab-title">{{message}}</div>
                {% for num in range(1, 6) %}
                <input type="text" name="Prio_{{ num }}" placeholder="Prio {{ num }}:"
                       value="{{ topFiveList[num-1] if topFiveList|length >= num else '' }}">
                {% endfor %}
                <button type="submit" name="my_list">Spara</button>
            </form>
        </div>
    </div>
</div>

<div id="day-section" class="grid-container">
    <div id="score-section" class="list-container">
        <div class="list-header">
            <h3 onclick="window.location.href = '/pmg/streak';">My Week</h3>
        </div>
        <div class="list-content">
            <img style=" width:100%; height: 100%" src="data:image/png;base64,{{ plot_url }}" alt="Aktivitetsgraf"/>
        </div>
    </div>

    <div id="startaAktivitet" class="button-center">
        <a  href="{{ url_for('pmg.goals', start_activity=1) }}" >
            <button class="button-style" style="border-radius: 50%; min-height: 150px; min-width: 150px; background-color: mediumseagreen" type="submit">New</button>
        </a>
    </div>

    <div id="streak-section" class="list-container">
        <div class="list-header">
            <h3 onclick="window.location.href = '/pmg/streak';">Streaks</h3>
        </div>
        {% if my_streaks %}
            <div class="list-content">
            {% for streak in my_streaks %}
                <div class="list-item">
                    <label>{{ streak.name }}</label>
                    <label>Igår: {{ streak.yesterday_value }}</label>
                    <form action="{{ url_for('pmg.update_streak', streak_id=streak.id, action='check') }}" method="post" style="display: flex; justify-content: center; align-items: center;">
                        {% if streak.type == "number" %}
                            <input type="number" name="amount" style="background: #f0f0f0; height: 20px; width: 40px; text-align: center; margin-right: 40px;">
                        {% endif %}
                            <button class="streak-icon" type="submit" style="border: none; background: none; margin-right: 10px;">
                                <svg id="checkbox-{{ streak.id }}" class="checkbox" xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 242 216">
                                    <ellipse id="background-{{ streak.id }}" class="background" cx="121" cy="108" rx="121" ry="108" fill="green"/>
                                    <path id="check" d="M38.5133 122.529L65.1039 95.7875L107.94 135.826L215.29 52.7692L101.124 171.413L38.5133 122.529Z" fill="white"/>
                                </svg>
                            </button>
                    </form>
                </div>
            {% endfor %}
            </div>
        {% endif %}
        </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="{{ url_for('static', filename='common_functions.js') }}"></script>

<script>

    var el = document.getElementById('topFiveTable');
    var sortable = Sortable.create(el, {
        animation: 150,
        onEnd: function(evt) {
            var order = [];
            document.querySelectorAll('#topFiveTable tr[data-id]').forEach(function(row) {
                order.push(row.getAttribute('data-id'));
            });
            // Skicka sorteringen till servern via AJAX
            fetch('/update_top_five_order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}',
                },
                body: JSON.stringify({order: order})
            });
        }
    });

document.addEventListener("DOMContentLoaded", function () {
    // Hämta topFiveList från servern via Jinja2
    const topFiveList = {{ topFiveList | tojson }};
    const headList = document.querySelector('.head-list');
    const listContent = headList.nextElementSibling;

    // Kontrollera om topFiveList är tom
    if (topFiveList.length === 0) {
        // Lägg till 'active'-klassen direkt och visa innehållet
        headList.classList.add('active');
        listContent.style.opacity = '1';
        listContent.style.pointerEvents = 'auto';
    }
});

function toggleList(element) {
    // Stäng andra öppna element
    document.querySelectorAll('.head-list.active').forEach(activeElement => {
        if (activeElement !== element) {
            activeElement.classList.remove('active');
            activeElement.nextElementSibling.style.opacity = '0';
            activeElement.nextElementSibling.style.pointerEvents = 'none';
        }
    });

    // Växla synlighet för det klickade elementet
    const list = element.nextElementSibling;
    if (element.classList.contains('active')) {
        element.classList.remove('active');
        list.style.opacity = '0';
        list.style.pointerEvents = 'none';
    } else {
        element.classList.add('active');
        list.style.opacity = '1';
        list.style.pointerEvents = 'auto';
    }
}
    // Kör funktionen när sidan laddas
    document.addEventListener("DOMContentLoaded", function() {
        if (localStorage.getItem('active') === 'true') {
            let activityId = localStorage.getItem('selectedActivityId')
            console.log("En aktivitet är redan aktiv.");
            window.location.href = `/pmg/focus_room/${activityId}`;
        }
    });

</script>
{% endblock body %}