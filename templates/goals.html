{% extends 'base.html' %}

{% block head %}
    <style>
        .goals-main {
            display: flex;
            flex-direction: column;
            align-items: center; /* Centrerar barn vertikalt i mitten */
            margin-top: 40px; /* 40px marginal från toppen */
            width: 100%;
        }
        .toggle-button {
            background: none;
            border: none;
            color: #000000; /* Röd färg */
            font-size: 16px;
            cursor: pointer;
        }
        .goals-container-wrapper {
            width: 70%; /* Justerar bredden på hela målcontainern */
            display: flex;
            flex-direction: column; /* Stackar barn vertikalt */
            align-items: center; /* Centrerar barn i mitten */
        }
        form {
            padding: 10px;
            display: flex;
            width: 80%;
            align-self: center;
        }
        .activity {
            margin-left: 70px;
            padding: 5px;
        }
        .goals-box {
            border: 1px solid #000;
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column; /* Ensure the main direction is column */
            align-items: flex-start; /* Align items to the start on the cross-axis */
            height: auto;
            min-height: 50px;
        }
        .goals-box > div:first-child { /* Assuming the first div contains the header and button */
            display: flex;
            width: 100%;
            justify-content: space-between; /* This separates the button and the rest to opposite ends */
        }
        #new-goal-form, #new-goal-form * {
            width: 100%; /* Fyller hela bredden av sin container */
            margin: 5px 0; /* Lägger till marginal ovanför och under varje element */
        }

        #new-goal-form button {
            padding: 8px; /* Ger extra utrymme inuti knappen */
        }

        button {
            align-self: center;
            cursor: pointer; /* Gör muspekaren till en pekare när den hovrar över knappar */
        }

        input[type="text"], select {
            padding: 8px;
            margin: 5px 0; /* Samma vertikalt utrymme för alla inmatningsfält */
        }
    </style>
{% endblock head %}

{% block body %}
<div class="goals-main">
    <div class="goals-container-wrapper">
        {% if goals %}
            {% for goal in goals %}
            <div class="goals-box">
                <div style="display: flex; align-items: center; width: 100%;">
                    <button class="toggle-button" onclick="toggleActivities(this)">▼</button>
                    <h3 style="margin-left: 10px;">{{ goal.name }}</h3>
                    <button onclick="deleteGoal({{ goal.id }})">Radera Mål</button>
                </div>
                <div class="activity-list" style="display: none;">
                    {% for activity in goal.activities %}
                    <div class="activity">{{ activity.name }}</div>
                    {% endfor %}
                    <button onclick="showAddActivityForm(event, this)">Add Activity</button>
                    <form method="POST" id="add-activity-form" style="display: none;">
                        <input type="hidden" name="goalId" value="{{ goal.id }}">
                        <input type="text" name="activity-name" placeholder="Activity Name" required>
                        <select id="new-goal-activity" name="activity-measurement">
                            <option value="tid">Tid</option>
                            <option value="antal">Antal</option>
                        </select>
                        <button type="submit" name="action" value="addActivity">Save Activity</button>
                        <button type="button" onclick="hideAddActivityForm(event, this)">Cancel</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        {% endif %}
        <button id="new-goal-button" onclick="expandNewGoalForm()">New Goal</button>
        <form method="POST" id="new-goal-form" style="display: none;">
            <input type="text" placeholder="Goal Name" name="goalName">
            <button type="submit" name="action" value="addGoal">Save</button>
            <button type="button" onclick="cancelNewGoalForm()">Cancel</button>
        </form>
    </div>
</div>
<script>
    function deleteGoal(goalId) {
        if (confirm('Är du säker på att du vill radera detta mål?')) {
            fetch('/delete-goal/' + goalId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ goalId: goalId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Målet har raderats!');
                    location.reload(); // Ladda om sidan för att uppdatera listan
                } else {
                    alert('Ett fel inträffade. Försök igen.');
                }
            });
        }
    }

function toggleActivities(button) {
    event.stopPropagation(); // Förhindra bubbling av event till högre element
    var goalsBox = button.closest('.goals-box'); // Hämta närmaste mållåda
    var activityList = goalsBox.querySelector('.activity-list'); // Hämta aktivitetslistan
    activityList.style.display = activityList.style.display === 'none' ? 'block' : 'none'; // Visa eller dölj aktivitetslistan
    button.textContent = activityList.style.display === 'none' ? '▼' : '▲'; // Ändra pilens riktning
}
function showAddActivityForm(event, button) {
    event.stopPropagation(); // Stoppa event-bubbling
    var form = button.nextElementSibling;
    form.style.display = 'block';
    button.style.display = 'none';
}

function hideAddActivityForm(event, button) {
    event.stopPropagation(); // Stoppa event-bubbling
    var form = button.parentElement;
    form.style.display = 'none';
    form.previousElementSibling.style.display = 'block'; // Visa "Add Activity"-knappen igen
}
function expandNewGoalForm() {
    document.getElementById('new-goal-button').style.display = 'none';
    document.getElementById('new-goal-form').style.display = 'block';
}

function cancelNewGoalForm() {
    document.getElementById('new-goal-form').style.display = 'none';
    document.getElementById('new-goal-button').style.display = 'block';
}
</script>
{% endblock body %}